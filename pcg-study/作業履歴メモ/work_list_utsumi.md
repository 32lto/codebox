# 内海作業履歴

## 20210123  
### RDSとの連携  
- vhosts.iniを変更（DB接続情報を入れるための環境変数をセット）

### MVCモデルに従い、modelsにDB関係の処理を分離  
- db.py作成  
- modelsディレクトリ作成  
- rankings.py作成  

## 20210107
アプリケーションを更新
- welcome.htmlの画像にリンクを追加
- ランキングページの見た目を実装
    ※DBとの連携まではできていないため、以下で代替。
        １．Flask（Python）側で仮想DBとしてjsonファイルを読み込み
        ２．Vue.jsに値を引き渡して表示

## 20210104
アプリケーションを大幅に更新してデプロイ
- トップページ作成
-  Unityゲームのデプロイテスト
-  layout用htmlファイル（layout.html）の作成と適用
-  ナビゲーションバーの実装

## 20201228
- 検証環境として、「KWEB001」、「KAPL001」EC2インスタンスを作成。
　　→あくまで1229の試験用。ずっと運用していくと疲れるので...
    →本番と同じ鍵・ユーザ（pcg-adman）で入れます。ログインマクロ配置済。
- 「KWEB001」、「KAPL001」EC2インスタンスの初期設定実施。

## 20201227
- Webサーバにおいて、ドキュメントルートをデフォルトの「/usr/share/nginx/html」から変更
    →セキュリティ対策
- Webサーバにおいて、Unityファイルのドキュメントルートをalias指定によって変更
    →ドキュメントルートがすべて一緒だと見づらいので
- アプリケーションサーバにおいて、.pyファイルの置き場としてappディレクトリを設置
    →iniファイルと同階層は見づらいため
- アプリチームが気軽にデプロイしてテストできるように、「アプリチーム向け.md」をナレッジフォルダに作成

## 20201106
- 管理者ユーザとして「pcg-adman」を作成し、ec2-userを削除
    →圧倒的に狙われやすいので...パスワードなしでrootになれる状態になってます  
- SSH鍵をパスフレーズつきのものに変更
    →鍵だけ流出しても入れないように

## 20201103
- 「Route53_Aレコード自動書き換えスクリプト」をリファクタリング

## 20201022
- Certificate Managerによる証明書発行（無料）
    以下の参考サイトの手順で実施。  
    参考：https://recipe.kc-cloud.jp/archives/11084  
    ※Route53での設定は済んでいたので  「ACMからの証明書発行」から実施。    
    ※エビデンス→image内「CertificateManagerによる証明書発行.png」  

- ELBの作成
    Webサーバ用（DMZ）LBを作成。名前は「HWEB-LB」  
    以下の参考サイトの手順で実施。 
    参考：https://recipe.kc-cloud.jp/archives/11084 
    ※エビデンスはimage内「HWEB-LB.png」
    ※ELBのセキュリティグループではHTTPとHTTPSのみ許可
    ※HTTPのリクエストはHTTPSにリダイレクトする用にリスナー設定済

- Route53にてELBに紐づくレコードを作成※
    www.parallelgame.netのAレコードに作成したELBを登録。  
    ※エビデンスはimage内「Route53設定（ELBレコード登録).png」  

- ※に伴い、WEBサーバのAレコードをwww.~ → hweb001.~に変更。  
    合わせて「Route53_Aレコード自動書き換えスクリプト」もログインマクロも変更済み。

- ELB作成に伴い、セキュリティグループを一部変更
    - フロントWebサーバ用セキュリティグループ「WebServer_SG」  
        →ELBのセキュリティグループ「HWEB-LB-SG」からのHTTP通信のみを許可

- UnityのWebGLファイルが無事動くことをテスト
    テスト用のたこやきクソゲーが動いたのでOkと思われる

## 20201012
- EC2でWebアプリケーション（uWSGI）サーバ「HAPL001」を作成
- Route53にてHAPL001のドメイン名を登録
    ※ドメイン名を用意しないとログインに手間がかかるため、運用効率化のために実施。  
    　サービス提供の観点では必要なし
- uWSGIのインストール
- uWSGIの諸設定実施（作業ログ：HAPL001_20201012.txtおよびHAPL001_20201012_2.txt参照）
- HWEB001に必要な設定を実施(作業ログ：HWEB001_20201012.txtを参照)
- 「設定ファイル」フォルダを作成。
    └nginx.confやuwsgi.iniなどの設定ファイルをここに格納していく想定。
- 「ツール」フォルダに「スクリプト」フォルダを作成。  
    └スクリプトを格納していく想定
-　「スクリプト」内に「Route53_Aレコード自動書き換えスクリプト」を作成
    └EC2＋動的IP環境下でも常にドメイン名にIPアドレスが紐づく状態を作れます。良かったらご活用ください。
- 「設定書」内に「環境定義書」フォルダ作成
    └IPアドレスなど、一覧化しておかないと大変なものをメモベースでおいていく想定

## 20201005

### Route53設定
- HostZone "parallelgame.net" 作成
- AレコードにWebサーバ "www.parallelgame.net"を登録
- Elastic IP を利用せずに、Amazon EC2と Route 53 のドメイン名を紐付ける設定実施 
    →参考：https://www.kiminonahaseichi.link/memo/2017/08/elastic-ip-amazon-ec2-route-53.html  
上記に伴い、下記をAWS上にて作成。
- IAMユーザ　"DNS_Set_Man"  
- IAMポリシー "DNS_Record_Setter"


## 20201004  
### Cloud Formation設定
- VPCを自動作成するCloudFormationを用意  
    これに伴いPCG-vpcも作成し直しました。  
    手順は[こちら](https://bitbucket.org/yurei20200912/prd_pcg/src/feature/%E3%83%8A%E3%83%AC%E3%83%83%E3%82%B8/CloudFormation%E9%96%A2%E4%BF%82/01_VPCSet.yaml%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9.md "01_VPCSet.yamlの使い方.md")参照  

### EC2設定
- 基本的な設定の導入
    [作業ログ]()  参照  

## 20200924
### ★Git
- featureブランチの作成  
- 「設計書」、「作業ログ」、「作業履歴メモ」、「ナレッジ」、「ツール」フォルダの作成  

### ドキュメント更新
- AWS構成図作成  
    →~prd_pcg\設計書\構成図
- ナレッジ追加  
    →~prd_pcg\ナレッジ  
    　└draw.ioでAWS構成図を書く.txt  
  
### ★AWS設定
- VPC・サブネット・IGW・ルートテーブル作成  
   →"PCG_VPC"  
  
- フロント（Nginx)用のWebサーバ作成
    PCG_Public1に配置。  
    Nameタグはそれっぽく"HWEB001"（本番Webサーバ1号機,的な？）にしてみました。  
    基本無料枠＆デフォルト。ただ、「終了保護の有効化」だけOnにしました。  
    セキュリティグループは後述の「WebServer_SG」にしました。  
    キーペア名は「HWEB001_key」。後ほど配ります。  

- セキュリティグループ「WebServer_SG」作成 
    まだWebサーバ立ててないので、とりあえずポート22のみ許可。

- ★ツールフォルダ
    →~prd_pcg\ツール「【ログインマクロ参考用】HWEB001.ttl」作成  
    →鍵パスやIPなどは適宜変更必要ですが、読み替えてください。  
  

